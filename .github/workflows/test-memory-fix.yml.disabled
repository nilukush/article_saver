name: Test Memory Fix

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Show system info
        run: |
          echo "=== System Memory ==="
          free -h
          echo "=== CPU Info ==="
          nproc
          lscpu | grep "CPU(s)"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19.0'
      
      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10
      
      - name: Show memory after swap
        run: |
          echo "=== Memory with Swap ==="
          free -h
      
      - name: Install with correct memory limit
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NX_DAEMON: false
        run: |
          echo "Installing dependencies with 4GB heap limit..."
          npm ci --no-audit --no-fund --prefer-offline